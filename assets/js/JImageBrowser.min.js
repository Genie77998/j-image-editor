"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function easeInExpo(t){return 0===t?0:pow(2,10*t-10)}function easeOutExpo(t){return 1===t?1:1-pow(2,-10*t)}function easeInOutExpo(t){return 0===t?0:1===t?1:t<.5?pow(2,20*t-10)/2:(2-pow(2,-20*t+10))/2}function type(t){var e=Object.prototype.toString;return t instanceof Element?"element":{"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Uint8ClampedArray]":"array","[object ImageData]":"array","[object Date]":"date","[object RegExp]":"regExp","[object Undefined]":"undefined","[object Null]":"null","[object Object]":"object"}[e.call(t)]}function deepClone(t){var e,i,a,s=type(t);if("array"===s)e=[];else{if("object"!==s)return t;e={}}if("array"===s){for(i=0,a=t.length;i<a;i++)e.push(deepClone(t[i]));return e}if("object"===s){for(i in t)e[i]=deepClone(t[i]);return e}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),pow=Math.pow,sqrt=Math.sqrt,sin=Math.sin,cos=Math.cos,PI=Math.PI,c1=1.70158,c2=1.525*c1,c3=c1+1,c4=2*PI/3,c5=2*PI/4.5,commonCanvas=document.createElement("canvas");commonCanvas.style.display="none";var ImageEditor=function(){function t(e){_classCallCheck(this,t),this.options=e,this.created=this.options.created||function(t){console.log("created")},this.beforeReadFile=this.options.beforeReadFile||function(t){console.log("beforeReadFile")},this.afterReadFile=this.options.afterReadFile||function(t){console.log("afterReadFile")},this.beforeLoadImage=this.options.beforeLoadImage||function(t){console.log("beforeLoadImage")},this.afterLoadImage=this.options.afterLoadImage||function(t){console.log("afterLoadImage")},this.beforeSave=this.options.beforeSave||function(){console.log("beforeSave")},this.afterSave=this.options.afterSave||function(t,e){console.log("afterSave")},this.afterRender=this.options.afterRender||function(){console.log("afterRender")},this.canvas1,this.canvas2,this.shadowImageCanvas=document.createElement("canvas"),this.width=e.width,this.height=e.height,this.animationFrame={},this.center={x:0,y:0},this.editorRect={x:300,y:300,w:e.limit.maxWidth||200,h:e.limit.maxHeight||200},this.imageRect={x:0,y:0,w:0,h:0,centerx:0,centery:0},this.imageTransform={translatex:0,translatey:0,scale:1,scaleCenter:{x:0,y:0,initx:0,inity:0},rotate:0},this.targetTransform={translatex:0,translatey:0,scale:1,scaleCenter:{x:0,y:0,initx:0,inity:0},rotate:0},this.offset={translatex:0,translatey:0,rotate:0,scale:0,scaleCenter:{x:0,y:0,initx:0,inity:0}},this.scaleTime=0,this.rotateTime=0,this.scale=this.initScale=1,this.rotate=this.initRotate=0,this.image,this.shadowImage,this.imageLoaded=!1,this.lineWidth=1,this.controllersContainer,this.container,this.limit={maxHeight:e.limit.maxHeight||0,maxWidth:e.limit.maxWidth||0,minHeight:e.limit.minHeight||0,minWidth:e.limit.minWidth||0,proportion:e.limit.proportion||0,maxSize:e.limit.maxSize||0},this.init()}return _createClass(t,[{key:"init",value:function(){this.createCanvas(),this.initEvent(),this.initImage()}},{key:"initEvent",value:function(){var t=this,e=this.canvas1,i={x:0,y:0},a=i,s={x:0,y:0},n=!1,r=function(t){return n&&(a={x:t.pageX,y:t.pageY},s={x:a.x-i.x,y:a.y-i.y},i=a),s};this.container.addEventListener("mousewheel",function(e){e.stopPropagation(),e.preventDefault();var i=0,a=0;e.wheelDelta?i=e.wheelDelta>0?1:-1:e.detail&&(i=e.detail<0?1:-1),a=i>0?.02:-.02,t.transformImage({scaleCenter:{x:e.pageX,y:e.pageY,scale:a}})}),e.addEventListener("mousedown",function(t){t.preventDefault(),n=!0,i={x:t.pageX,y:t.pageY}}),e.addEventListener("mousemove",function(e){if(e.preventDefault(),n){var i=r(e);t.transformImage({translatex:i.x,translatey:i.y})}}),e.addEventListener("mouseup",function(t){t.preventDefault(),n=!1}),e.addEventListener("mouseout",function(t){t.preventDefault(),n=!1})}},{key:"createCanvas",value:function(){var t=this.canvas1=document.createElement("canvas"),e=this.canvas2=document.createElement("canvas"),i=this.container=document.querySelector(this.options.container);i.appendChild(t),i.appendChild(e),this.refreshCanvasStyle(),this.created(this)}},{key:"refreshCanvasStyle",value:function(){var t=this.canvas1,e=this.canvas2,i=this.container;this.width||(this.width=i.offsetWidth),this.height||(this.height=i.offsetHeight),t.width=e.width=this.width,t.height=e.height=this.height,t.style.zIndex="10",this.center={x:t.width/2,y:t.height/2},this.editorRect.x=this.center.x-this.editorRect.w/2,this.editorRect.y=this.center.y-this.editorRect.h/2,t.style.position="absolute",t.style.top=t.style.left="0",e.style.display="none"}},{key:"initImage",value:function(t,e){var i=this;if("object"==(void 0===t?"undefined":_typeof(t)))this.image=t,e&&e(),this.beforeLoadImage(),this.afterLoadImage(this.image),this.refreshCanvasStyle(),this.startDraw();else{if(this.image=new Image,t&&(this.options.imageUrl=t),!this.options.imageUrl)return;this.image.onload=function(){e&&e(),i.afterLoadImage(i.image),i.refreshCanvasStyle(),i.startDraw()},this.beforeLoadImage(this.options.imageUrl),this.image.src=this.options.imageUrl}this.clearCanvas()}},{key:"initStage",value:function(t){this.scale=this.initScale=1,this.rotate=this.initRotate=0,this.imageRect={w:this.image.width,h:this.image.height,centerx:this.image.width/2,centery:this.image.height/2},this.shadowImageCanvas.width=this.image.width,this.shadowImageCanvas.height=this.image.height,this.imageFitScreen()}},{key:"imageFitScreen",value:function(){var t=this.width,e=this.height,i=this.image.width,a=this.image.height,s=i/a,n=0,r=0,o=0,h=this.rotate+this.offset.rotate;if(h%180!=0){var c=t;t=e,e=c}s>t/e?(r=t,0,e/2-(n=t/s)/2,h%180!=0&&(e/2-r/2,t/2-n/2),this.initScale=r/i,o=this.initScale-this.scale):(n=e,t/2-(r=s*e)/2,0,h%180!=0&&(e/2-r/2,t/2-n/2),this.initScale=n/a,o=this.initScale-this.scale),this.targetTransform.translatex=0,this.targetTransform.translatey=0,this.targetTransform.scaleCenter={x:0,y:0,initx:0,inity:0},this.scaleInCenter(o)}},{key:"startDraw",value:function(){var t=this,e=this.canvas2.getContext("2d"),i=this.canvas1.getContext("2d");this.initStage(i),window.cancelAnimationFrame(this.animationFrame);!function a(){t.update(),t.render(i,e),t.animationFrame=window.requestAnimationFrame(a)}(),this.afterRender()}},{key:"clearCanvas",value:function(){this.canvas1.getContext("2d").clearRect(0,0,this.width,this.height),window.cancelAnimationFrame(this.animationFrame)}},{key:"transformImage",value:function(t){var e=t.translatex||0,i=t.translatey||0,a=t.scaleCenter;if(e&&(this.targetTransform.translatex+=e/this.scale),i&&(this.targetTransform.translatey+=i/this.scale),a){if(a.x!=this.targetTransform.scaleCenter.x&&this.targetTransform.scaleCenter.y!=a.y){var s=this.targetTransform.scaleCenter.x,n=this.targetTransform.scaleCenter.y;this.targetTransform.scaleCenter.x=a.x,this.targetTransform.scaleCenter.y=a.y;var r=this.targetTransform.scaleCenter.initx,o=this.targetTransform.scaleCenter.inity,h=this.scale,c=(this.scale,this.image.width*h),l=this.image.height*h,f=s-(s-r)*h,m=n-(n-o)*h,g=(a.x-f)/c,d=(a.y-m)/l,u=a.x-this.image.width*g,y=a.y-this.image.height*d;this.targetTransform.scaleCenter.initx=u,this.targetTransform.scaleCenter.inity=y}this.scaleTo(a.scale)}}},{key:"applyTransform",value:function(t,e){t.translate(e.scaleCenter.x,e.scaleCenter.y),t.scale(this.scale,this.scale),t.translate(e.scaleCenter.initx-e.scaleCenter.x,e.scaleCenter.inity-e.scaleCenter.y),t.translate(e.translatex,e.translatey),t.translate(this.imageRect.centerx,this.imageRect.centery),t.rotate(this.rotate/180*Math.PI),t.translate(-this.imageRect.centerx,-this.imageRect.centery)}},{key:"scaleTo",value:function(t){t?(this.scaleTime=0,this.initScale=this.scale,this.offset.scale*t<0&&(this.offset.scale=0),this.offset.scale+=t):this.offset.scale=0}},{key:"scaleInCenter",value:function(t){this.targetTransform.scaleCenter.x=this.center.x,this.targetTransform.scaleCenter.y=this.center.y,this.targetTransform.scaleCenter.initx=(this.width-this.image.width)/2,this.targetTransform.scaleCenter.inity=(this.height-this.image.height)/2,this.scaleTo(0),this.scaleTo(t)}},{key:"update",value:function(){var t=this.imageTransform,e=this.targetTransform;t.translatex=e.translatex,t.translatey=e.translatey,this.scaleTime<1?(this.scaleTime+=.01,this.scale=easeOutExpo(this.scaleTime)*this.offset.scale+this.initScale,this.scale<.05&&(this.scale=.05,this.scaleTime=1)):(this.offset.scale=0,this.scaleTime=1),this.rotateTime<1?(this.rotateTime+=.01,this.rotate=easeOutExpo(this.rotateTime)*this.offset.rotate+this.initRotate):(this.rotate=this.offset.rotate+this.initRotate,360==this.rotate&&(this.rotate=0),this.offset.rotate=0,this.initRotate=this.rotate,this.rotateTime=1),t.scaleCenter.x=e.scaleCenter.x,t.scaleCenter.y=e.scaleCenter.y,t.scaleCenter.initx=e.scaleCenter.initx,t.scaleCenter.inity=e.scaleCenter.inity}},{key:"render",value:function(t,e){var i=this.imageTransform;this.editorRect.x,this.editorRect.y,this.editorRect.w,this.editorRect.h;t.clearRect(0,0,this.width,this.height),t.save(),this.applyTransform(t,i),t.drawImage(this.image,0,0),t.restore(),t.font="10px Verdana",t.fillStyle="#fff",t.fillText("缩放： "+parseInt(100*this.scale)+"%",10,20),t.fillText("图片大小： "+this.image.width+"*"+this.image.height,10,40)}},{key:"rotateZ",value:function(t){1==this.rotateTime&&(this.offset.rotate=t,this.rotateTime=0,this.imageFitScreen())}},{key:"readFile",value:function(t){var e=this;if(this.beforeReadFile(t),FileReader){var i=new FileReader;i.readAsDataURL(t),i.onload=function(t){e.initImage(t.target.result),e.afterReadFile(t.target.result)}}else{var a=window.URL.createObjectURL(t);this.initImage(a),this.afterReadFile(a)}this.clearCanvas()}}]),t}(),throttle=function(){var t={},e=!1;return function(i){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:17;e||(i(),e=!0,t=setTimeout(function(){e=!1},a))}}();